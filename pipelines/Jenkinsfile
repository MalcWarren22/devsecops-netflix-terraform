pipeline {
  agent any

  environment {
    AWS_REGION = 'us-east-2'
    ROLE_ARN   = 'arn:aws:iam::902917581625:role/devsecops-netflix-dev-jenkins-deploy-role'
    TF_DIR     = 'stacks/tools-ec2'
    CREDS_FILE = '.aws_sts_env'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Assume Deploy Role') {
      steps {
        sh '''
          bash -lc '
            set -euo pipefail

            # Assume role and capture creds
            CREDS=$(aws sts assume-role \
              --role-arn "$ROLE_ARN" \
              --role-session-name "jenkins-${BUILD_NUMBER}")

            AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r ".Credentials.AccessKeyId")
            AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r ".Credentials.SecretAccessKey")
            AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r ".Credentials.SessionToken")

            # Persist creds for subsequent stages (exports in one sh step do NOT persist)
            cat > "$CREDS_FILE" <<EOF
export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
export AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
export AWS_REGION=${AWS_REGION}
export AWS_DEFAULT_REGION=${AWS_REGION}
EOF
            chmod 600 "$CREDS_FILE"

            # Prove identity
            source "$CREDS_FILE"
            aws sts get-caller-identity
          '
        '''
      }
    }

    stage('Terraform fmt') {
      steps {
        sh '''
          bash -lc '
            set -euo pipefail
            source "$CREDS_FILE"

            cd "$TF_DIR"
            terraform fmt -check -recursive
          '
        '''
      }
    }

    stage('Terraform init/validate') {
      steps {
        sh '''
          bash -lc '
            set -euo pipefail
            source "$CREDS_FILE"

            cd "$TF_DIR"
            terraform init -input=false
            terraform validate
          '
        '''
      }
    }

    stage('Terraform plan') {
      steps {
        sh '''
          bash -lc '
            set -euo pipefail
            source "$CREDS_FILE"

            cd "$TF_DIR"
            terraform plan -input=false -no-color -var-file=../env/dev.jenkins.tfvars
          '
        '''
      }
    }

    stage('Terraform apply (manual gate)') {
      when {
        branch 'main'
      }
      steps {
        input message: "Apply Terraform in ${env.TF_DIR} to AWS?", ok: "Apply"
        sh '''
          bash -lc '
            set -euo pipefail
            source "$CREDS_FILE"

            cd "$TF_DIR"
            terraform apply -input=false -auto-approve
          '
        '''
      }
    }
  }

  post {
    always {
      sh '''
        bash -lc '
          rm -f "$CREDS_FILE" || true
        '
      '''
    }
  }
}
